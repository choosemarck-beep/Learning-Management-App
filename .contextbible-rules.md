# Context Bible Rules - Learning Management System Web App

**Version**: 1.3  
**Last Updated**: December 2024  
**Purpose**: Technical implementation rules and business logic requirements extracted from CONTEXTBIBLE.md. All agents MUST adhere to these rules when implementing features.

**Note**: This file complements `.cursorrules` with detailed technical specifications, database schema rules, business logic, and implementation patterns. Both files must be followed.

---

## Database Schema & Data Model Rules

### User Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `email`: String (unique) - Required, must be unique
  - `name`: String - Required
  - `password`: String (hashed) - Required, must be hashed with bcryptjs
  - `xp`: Int (default 0) - Gamification points
  - `level`: Int (default 1) - User level
  - `rank`: String (default "Deckhand") - User rank/title
  - `streak`: Int (default 0) - Daily login streak
  - `diamonds`: Int (default 0) - Energy crystals currency
- **OPTIONAL FIELDS**:
  - `avatar`: String? - User avatar URL
- **EMPLOYEE FIELDS** (for internal registration):
  - `employeeNumber`: String? (unique) - Employee ID, optional but required for registration
  - `hireType`: HireType? - Required for registration ("DIRECT_HIRE" | "AGENCY")
  - `phone`: String? - Required for registration
  - `companyId`: String? (foreign key) - Required for registration, references Company
  - `positionId`: String? (foreign key) - Required for registration, references Position
  - `department`: String? - Optional
  - `branch`: String? - Optional
  - `hireDate`: DateTime? - Optional
- **RELATIONS**: Must support Company (many-to-one), Position (many-to-one), CourseProgress[], TaskCompletion[], Badge[], Session[]

### Company Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `name`: String (unique) - Required, company/agency name
  - `type`: CompanyType - Required ("COMPANY" | "AGENCY")
  - `isActive`: Boolean (default true) - For soft delete
- **RELATIONS**: Must support User[] (one-to-many)
- **ADMIN MANAGEMENT**: Companies managed by admins via admin interface

### Position Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `title`: String (unique) - Required, position title
  - `role`: UserRole - Required, auto-assigned role (EMPLOYEE or BRANCH_MANAGER)
  - `isActive`: Boolean (default true) - For soft delete
- **RELATIONS**: Must support User[] (one-to-many)
- **ROLE DETECTION**: Position.role determines user role during registration
- **ADMIN MANAGEMENT**: Positions managed by admins via admin interface

### Course Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `title`: String - Required
  - `description`: String - Required
  - `totalXP`: Int (default 0) - Total XP available in course
  - `isPublished`: Boolean (default false) - Must be true for users to see
- **OPTIONAL FIELDS**:
  - `thumbnail`: String? - Course thumbnail URL
- **RELATIONS**: Must support Module[], CourseProgress[]
- **ACCESS RULE**: Courses with `isPublished: false` must NOT be visible to users

### Module Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `courseId`: String (foreign key) - Required, references Course
  - `title`: String - Required
  - `description`: String - Required
  - `order`: Int - Required, for ordering within course
  - `totalXP`: Int (default 0) - Total XP in module
- **RELATIONS**: Must support Course (many-to-one), Lesson[] (one-to-many)

### Lesson Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `moduleId`: String (foreign key) - Required, references Module
  - `title`: String - Required
  - `description`: String - Required
  - `order`: Int - Required, for ordering within module
  - `totalXP`: Int (default 0) - Total XP in lesson
- **RELATIONS**: Must support Module (many-to-one), Task[] (one-to-many)

### Task Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `lessonId`: String (foreign key) - Required, references Lesson
  - `title`: String - Required
  - `type`: String - Required, must be one of: "quiz" | "exercise" | "reading" | "interactive"
  - `content`: String (JSON, default "{}") - Task content stored as JSON
  - `order`: Int - Required, for ordering within lesson
  - `xpReward`: Int (default 10) - XP awarded on completion
- **RELATIONS**: Must support Lesson (many-to-one), TaskCompletion[] (many-to-many with User)

### CourseProgress Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `userId`: String (foreign key) - Required, references User
  - `courseId`: String (foreign key) - Required, references Course
  - `progress`: Float (0-100, default 0) - Completion percentage
  - `isCompleted`: Boolean (default false) - Completion status
- **UNIQUE CONSTRAINT**: [userId, courseId] - One progress record per user per course
- **CALCULATION RULE**: `progress = (completedTasks / totalTasks) * 100`

### TaskCompletion Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `userId`: String (foreign key) - Required, references User
  - `taskId`: String (foreign key) - Required, references Task
  - `completedAt`: DateTime (default now) - Completion timestamp
- **OPTIONAL FIELDS**:
  - `score`: Int? - Optional, for quiz tasks
- **UNIQUE CONSTRAINT**: [userId, taskId] - User can complete a task only once
- **XP RULE**: XP awarded only on first completion, no duplicate XP

### Badge Model Requirements
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `userId`: String (foreign key) - Required, references User
  - `type`: String - Required, badge type identifier
  - `name`: String - Required, badge display name
  - `description`: String - Required, badge description
  - `icon`: String - Required, icon identifier or URL
  - `earnedAt`: DateTime (default now) - When badge was earned
- **UNLOCK RULE**: One badge per type per user, unlocks automatically when criteria met

### Session Model Requirements (NextAuth.js)
- **MANDATORY FIELDS**:
  - `id`: String (cuid) - Primary key
  - `sessionToken`: String (unique) - Required, unique session token
  - `userId`: String (foreign key) - Required, references User
  - `expires`: DateTime - Required, session expiration
- **STRATEGY**: JWT (stateless), no database session storage for JWT strategy

### Data Relationship Rules
- User ‚Üí CourseProgress[] (many-to-many with Course)
- User ‚Üí TaskCompletion[] (many-to-many with Task)
- User ‚Üí Badge[] (one-to-many)
- User ‚Üí Session[] (one-to-many, NextAuth)
- Course ‚Üí Module[] (one-to-many)
- Course ‚Üí CourseProgress[] (many-to-many with User)
- Module ‚Üí Course (many-to-one)
- Module ‚Üí Lesson[] (one-to-many)
- Lesson ‚Üí Module (many-to-one)
- Lesson ‚Üí Task[] (one-to-many)
- Task ‚Üí Lesson (many-to-one)
- Task ‚Üí TaskCompletion[] (many-to-many with User)

---

## Authentication & Authorization Rules

### Authentication Flow (MANDATORY STEPS)
1. User submits email/password on `/login`
2. **MUST** validate credentials via Zod schema
3. **MUST** fetch user from database by email
4. **MUST** verify password with bcryptjs
5. **MUST** create JWT token with user data
6. **MUST** store session in JWT (no database session for JWT strategy)
7. **MUST** check session via middleware for protected routes

### Signup Flow (MANDATORY STEPS)
1. User submits email, name, password on `/signup`
2. **MUST** validate via Zod schema (email format, password min 6 chars)
3. **MUST** hash password with bcryptjs
4. **MUST** create user with default values:
   - `xp: 0`
   - `level: 1`
   - `rank: "Deckhand"`
   - `streak: 0`
   - `diamonds: 0`
5. **MUST** redirect user to login after successful signup

### Session Management Rules
- **Strategy**: JWT (stateless) - MUST use JWT strategy
- **Session Data**: MUST include `id`, `email`, `name`, `avatar`
- **Expiration**: Configured in NextAuth config
- **Middleware**: MUST protect `/dashboard` routes, redirect unauthenticated users

### Protected Routes Rules
- `/dashboard/**` - **REQUIRES** authentication
- Middleware **MUST** redirect to `/login?callbackUrl=/dashboard` if not authenticated
- Authenticated users **MUST** be redirected away from `/login` and `/signup`

### Password Security Rules
- **Hashing**: **MUST** use bcryptjs
- **Minimum Length**: 6 characters (enforced in Zod schema)
- **Storage**: **NEVER** store plain text passwords

---

## Gamification System Rules

### XP System (MANDATORY VALUES)
- **Task completion**: 10 XP (default `xpReward` in Task model)
- **Lesson completion**: 50 XP (awarded when all tasks in lesson completed)
- **Module completion**: 200 XP (awarded when all lessons in module completed)
- **Course completion**: 1000 XP (awarded when all modules in course completed)

### Level System Rules
- **XP per level**: 1000 XP
- **Max level**: 100
- **Level calculation**: `Math.floor(xp / 1000) + 1`
- **MUST** update user level when XP threshold reached

### Rank System Rules (Pixel Galaxy Theme)
Ranks **MUST** be assigned based on level and XP:
- Level 1 (0 XP): "Stellar Cadet"
- Level 5 (5,000 XP): "Space Explorer"
- Level 10 (10,000 XP): "Nebula Navigator"
- Level 15 (15,000 XP): "Star Seeker"
- Level 20 (20,000 XP): "Galaxy Guardian"
- Level 25 (25,000 XP): "Stellar Master"
- Level 30 (30,000 XP): "Cosmic Commander"
- Level 40 (40,000 XP): "Galaxy Master"
- Level 50 (50,000 XP): "Universal Legend"

### Streak System Rules
- **Streak bonus multiplier**: 1.5x XP (if streak active)
- **Max streak days**: 365
- **Daily login required**: User **MUST** log in daily to maintain streak
- **Reset rule**: Streak **MUST** reset if user misses a day

### Rewards (Energy Crystals/Diamonds) Rules
- **Crystals per XP**: 0.1 (1 crystal per 10 XP)
- **Daily reward crystals**: 50 (awarded on daily login)
- **Storage**: Stored in `User.diamonds` field
- **Calculation**: `diamonds = Math.floor(xp * 0.1) + dailyRewards`

### Badge System Rules
**MANDATORY Badge Types** (must be implemented):
- `first_task` - Complete first task
- `first_lesson` - Complete first lesson
- `first_module` - Complete first module
- `first_course` - Complete first course
- `streak_7` - 7-day streak
- `streak_30` - 30-day streak
- `streak_100` - 100-day streak
- `perfect_week` - Complete all tasks in a week
- `top_10_leaderboard` - Reach top 10 on leaderboard
- `level_10` - Reach level 10
- `level_25` - Reach level 25
- `level_50` - Reach level 50

**Badge Unlock Rules**:
- Badges **MUST** unlock automatically when criteria met
- One badge per type per user (enforced by unique constraint)
- Badge earned timestamp **MUST** be stored

### Leaderboard Rules
- **Update interval**: 1 hour (3,600,000 ms)
- **Rankings**: Based on total XP (descending)
- **Scope**: Global leaderboard (all users)
- **Future**: Squad/team leaderboards (planned)

---

## Business Logic & Rules

### User Registration Rules
1. **Email uniqueness**: Email **MUST** be unique (enforced by database)
2. **Password minimum**: 6 characters (enforced in Zod schema)
3. **Default values**: **MUST** set on user creation:
   - `xp: 0`
   - `level: 1`
   - `rank: "Deckhand"`
   - `streak: 0`
   - `diamonds: 0`
4. **Password hashing**: **MUST** hash with bcryptjs before storage
5. **Employee Number**: **MUST** be unique if provided (enforced by database)
6. **Hire Type**: **MUST** be selected (DIRECT_HIRE or AGENCY)
7. **Company Selection**: **MUST** select from active companies/agencies
8. **Position Selection**: **MUST** select from active positions
9. **Role Auto-Detection**: User role automatically determined from selected position.role field
10. **Default Role**: If position not found or role not set, default to EMPLOYEE
11. **Registration Access**: Only EMPLOYEE and BRANCH_MANAGER roles can self-register

### Registration Flow Rules (Internal Use)

**Multi-Step Process**:
1. **Step 1 - Personal Information**: Collect name, email, phone
2. **Step 2 - Employee Details**: Collect employee number, hire type, company, position, department, branch, hire date
3. **Step 3 - Account Setup**: Collect password and confirmation

**Role Auto-Detection**:
- After position selection in Step 2, query Position model
- Use `position.role` to assign user role
- Default to EMPLOYEE if position not found
- Only EMPLOYEE and BRANCH_MANAGER roles allowed for self-registration

**Validation Rules**:
- Each step must be validated before progression
- Employee number must be unique
- Email must be unique
- All required fields must be filled
- Password must match confirmation

**Data Flow**:
- Form data preserved between steps
- Final submission includes all collected data
- Role determined from position before user creation

### Course Access Rules
- **Visibility**: Courses **MUST** have `isPublished: true` to be visible to users
- **Access**: Users **CAN** access any published course
- **Progress tracking**: Progress **MUST** be tracked per user per course

### Progress Calculation Rules

**Course Progress Formula**:
```
progress = (completedTasks / totalTasks) * 100
```
- **Storage**: Stored in `CourseProgress.progress` (0-100)
- **Update**: **MUST** recalculate when task completion changes

**Task Completion Rules**:
- User **CAN** complete a task only once (enforced by unique constraint [userId, taskId])
- XP **MUST** be awarded on first completion only
- Score is optional (for quizzes only)

### XP Award System Rules
- **Award timing**: XP **MUST** be awarded on task completion
- **No duplicates**: **NO** duplicate XP for re-completing tasks
- **Streak bonus**: **MUST** apply 1.5x multiplier if streak active
- **Level up**: **MUST** update level when XP threshold reached (1000 XP per level)
- **User update**: **MUST** update `User.xp` and `User.level` fields

### Badge Unlocking Rules
- **Automatic unlock**: Badges **MUST** unlock automatically when criteria met
- **One per type**: One badge per type per user (enforced)
- **Timestamp**: Badge earned timestamp **MUST** be stored in `earnedAt`
- **Future**: Unlock animations (planned)

---

## Email Service Rules

### Email Service Selection

**Selected Service: SendGrid** (migrated from Resend, December 2024)

**Why SendGrid?**
- Free tier: 100 emails/day (3,000 emails/month) - sufficient for onboarding emails
- Can send to any email address (no domain verification required for free tier)
- No branding required in footer (professional appearance)
- React Email support for component-based templates
- Established, reliable service (owned by Twilio)
- Simple API, easy to implement
- Low vendor lock-in (standard API, abstraction layer implemented)
- TypeScript support
- Good deliverability

**Alternative Options Considered:**
1. **Postmark**: $10/month for 10,000 emails - Best deliverability, transactional focus (paid only)
2. **Brevo**: Free tier (9,000/month) but requires branding in footer
3. **Resend**: Free tier (3,000/month) but requires domain verification to send to any email
4. **Mailgun**: Free for 3 months, then $35/month - Developer-friendly
5. **Amazon SES**: $0.10 per 1,000 emails - Cost-effective at scale, complex setup
6. **Nodemailer + SMTP**: Free but requires SMTP provider, not ideal for production

**Implementation Strategy**: 
- Abstraction layer in `lib/email/client.ts` allows easy switching
- React Email templates in `lib/email/templates/`
- Environment variable: `SENDGRID_API_KEY`

**Email Types Required**:
- Onboarding emails (new user signup)
- Approval notifications (account approved/rejected)
- Password reset emails (future)
- Course completion notifications (future)

## API Structure Rules

### API Routes (MANDATORY)

**NextAuth.js Handler**:
- **Route**: `/api/auth/[...nextauth]`
- **Handles**: Login, logout, session management
- **Provider**: Credentials (email/password)

**Signup Endpoint**:
- **Route**: `/api/auth/signup`
- **Method**: POST
- **Body**: `{ name, email, phone, password, confirmPassword, employeeNumber, hireType, companyId, positionId, department, branch, hireDate }`
- **Response Format**: `{ success: boolean, user?: User, error?: string }`
- **Validation**: **MUST** validate input, hash password, create user
- **Role Detection**: **MUST** fetch position to auto-detect role from position.role
- **Employee Number**: **MUST** check uniqueness before creating user
- **Email**: **MUST** send onboarding email after user creation

**Companies Endpoint**:
- **Route**: `/api/companies`
- **Method**: GET
- **Query Params**: `type` (optional) - Filter by CompanyType ("COMPANY" | "AGENCY")
- **Response Format**: `{ success: boolean, data?: Company[], error?: string }`
- **Returns**: List of active companies/agencies

**Positions Endpoint**:
- **Route**: `/api/positions`
- **Method**: GET
- **Response Format**: `{ success: boolean, data?: Position[], error?: string }`
- **Returns**: List of active positions with role information

### API Response Format (MANDATORY)
All API responses **MUST** follow this format:
```typescript
{
  success: boolean;
  data?: T;
  error?: string;
}
```

### API Error Handling Rules
- **Consistent errors**: **MUST** return consistent error responses
- **Validation errors**: **MUST** return validation errors to client
- **Server errors**: **MUST** log server errors, return generic message to client

---

## Component Architecture Rules

### Component Organization (MANDATORY)
- **Base UI Components** (`/components/ui`): Reusable, generic components
  - **MUST** follow atomic design principles
  - **MUST** export TypeScript interfaces for props
  - **MUST** use CSS Modules for styling
- **Feature Components** (`/components/features`): Feature-specific, business logic components
- **Layout Components** (`/components/layout`): Page structure components (Header, Footer, Navigation)

### Component Structure Pattern (MANDATORY)
All components **MUST** follow this structure:
```typescript
// Component.tsx
import React from "react";
import styles from "./Component.module.css";

export interface ComponentProps {
  // Props interface
}

export const Component: React.FC<ComponentProps> = ({ ... }) => {
  return (
    <div className={styles.container}>
      {/* Component content */}
    </div>
  );
};
```

### Component Naming Rules
- **Components**: PascalCase (`TaskCard.tsx`)
- **Functions**: camelCase (`calculateXP()`)
- **Constants**: UPPER_SNAKE_CASE (`MAX_STREAK_DAYS`)
- **CSS classes**: camelCase (`.container`, `.inputGroup`)

### Key Component Specifications

**Button Component**:
- **Variants**: `primary`, `secondary`, `outline`, `ghost`
- **Sizes**: `sm`, `md`, `lg`
- **States**: `disabled`, `loading`
- **Touch target**: 44px minimum

**Input Component**:
- **MUST** support label, error, helper text
- **MUST** validate via React Hook Form
- **MUST** be accessible (ARIA labels, error announcements)

**Card Component**:
- **MUST** support Header, Body, Footer sections
- **MUST** use dark background with border
- **MUST** have rounded corners

**Logo Component**:
- **Text**: "LEARNING MANAGEMENT" (white, two lines)
- **Progress bar**: 20 segments with purple gradient
- **Arrow**: Triangular arrow at end
- **Configurable**: Progress percentage (default 66%)

**GalaxyBackground Component**:
- **Stars**: 150 moving stars (twinkling, slow drift)
- **Meteors**: 3 meteors with purple/indigo trails
- **Position**: Fixed position, z-index 0 (behind all content)
- **Technology**: Canvas-based animation

**IntroCarousel Component**:
- **Timing**: Automatic looping (4 seconds per slide)
- **Slides**: 4 introduction slides
- **Icons**: Gamified icons (Rocket, Sparkles, TrendingUp, Users)
- **Indicators**: Dot indicators (clickable)
- **Animation**: Smooth Framer Motion animations

---

## Project Structure Rules

### File Structure (MANDATORY)
Agents **MUST** follow this exact structure:

```
/app                    # Next.js App Router
  /(auth)              # Authentication routes (login, signup)
    /layout.tsx        # Auth layout with GalaxyBackground
    /login/            # Login page with IntroCarousel
    /signup/           # Signup page
  /(dashboard)        # Protected dashboard routes
    /layout.tsx        # Dashboard layout (Header, Navigation, Footer)
    /dashboard/        # Main dashboard page
  /api                 # API routes
    /auth/             # NextAuth.js routes
      /[...nextauth]/  # NextAuth handler
      /signup/         # User registration endpoint
  /globals.css         # Global styles, CSS variables, design system
  /layout.tsx          # Root layout (providers, fonts)
  /page.tsx            # Home page (landing)
  /providers.tsx       # React Query, NextAuth providers

/components            # React components
  /ui                  # Base UI components
    /assets/           # Gamified icon components
      - EnergyCrystal.tsx
      - StarCluster.tsx (Lucide Sparkles icon)
      - ProgressChart.tsx (Lucide TrendingUp)
      - CommunityIcon.tsx (Lucide Users)
      - RocketIcon.tsx (Lucide Rocket)
    - Badge.tsx
    - Button.tsx
    - Card.tsx
    - Input.tsx
    - Logo.tsx (LEARNING MANAGEMENT with progress bar)
    - ProgressBar.tsx
    - GalaxyBackground.tsx (animated stars & meteors)
  /features            # Feature-specific components
    - IntroCarousel.tsx (automatic looping carousel)
  /layout              # Layout components
    - Header.tsx
    - Footer.tsx
    - Navigation.tsx (mobile bottom nav)

/lib                   # Utilities and helpers
  /auth/               # Authentication utilities
    - config.ts        # NextAuth configuration
    - utils.ts         # Auth helper functions
    - index.ts         # Auth exports
  /prisma/             # Database client
    - client.ts        # Prisma client singleton
  /utils/              # Helper functions
    - cn.ts            # className utility (clsx wrapper)
  /constants/          # Constants and configs
    - colors.ts        # Color palette constants
    - gamification.ts  # Gamification rules (XP, levels, ranks)
    - theme.ts         # Theme constants (spacing, transitions)

/types                 # TypeScript types
  - index.ts           # Shared types
  - next-auth.d.ts     # NextAuth type extensions

/prisma                # Prisma schema and migrations
  /schema.prisma       # Database schema
  /migrations/         # Database migrations

/public                # Static assets
  - manifest.json      # PWA manifest

/docs                  # Documentation
  /product/            # Product documentation (PRDs, roadmap, backlog)
  /wireframes/         # Design wireframes
  /CONTEXTBIBLE.md     # Context documentation

/styles                # Shared CSS files
  - design-system.css  # Design system utilities (optional)
```

### Routing Structure Rules
- `/` - Home/landing page (Logo, CTA buttons)
- `/login` - Login page (IntroCarousel, login form)
- `/signup` - Signup page
- `/dashboard` - Main dashboard (protected)
- `/api/auth/[...nextauth]` - NextAuth.js handler
- `/api/auth/signup` - User registration endpoint

---

## Development Workflow Rules

### File Structure Rules (MANDATORY)
- **Components**: `Component.tsx` with `Component.module.css`
- **Utilities**: `lib/utils/functionName.ts`
- **Constants**: `lib/constants/category.ts`
- **Types**: `types/index.ts` or component-specific types

### Database Migration Rules
1. **MUST** update `prisma/schema.prisma`
2. **MUST** create migration: `npm run db:migrate`
3. **MUST** update Prisma client: `npm run db:generate`
4. **MUST** update TypeScript types if needed
5. **IMPORTANT**: Migrations **MUST** be run manually from local machine (no automatic hooks)

### Layout & Viewport Rules (CRITICAL - STRICT ENFORCEMENT)

**CRITICAL - Desktop Layout Exception (Admin/Super Admin ONLY)**:
- **Admin and Super Admin Dashboards**: MUST use desktop layouts with sidebar navigation
- **Routes**: `/admin/**` and `/super-admin/**` - Desktop layouts REQUIRED
- **Design Pattern**: 
  - Left sidebar navigation (dark theme, persistent, collapsible on mobile)
  - Top header bar (search, notifications, user profile dropdown)
  - Main content area with multi-column grid layouts (2-3 columns)
  - Card-based widgets and sections
  - Desktop-optimized spacing, typography, and interactions
- **Responsive Breakpoints** (Admin/Super Admin ONLY):
  ```css
  @media (min-width: 768px) { /* tablet - sidebar + content */ }
  @media (min-width: 1024px) { /* desktop - full sidebar + wide content */ }
  @media (min-width: 1440px) { /* large desktop - optimized spacing */ }
  ```
- **Employee/Branch Manager Pages**: MUST remain mobile-only (320px-428px viewports)
- **Routes**: `/employee/**` - Mobile-only, NO desktop breakpoints
- **Strict Enforcement**: Never use desktop layouts for employee/branch manager pages

### Common Patterns (MANDATORY)

**Creating a New Component**:
1. Create `Component.tsx` and `Component.module.css`
2. Use CSS variables from `globals.css`
3. Export TypeScript interface for props
4. Add to appropriate index.ts file
5. Follow mobile-first design rules (except admin/super-admin pages)

**Adding a New Route**:
1. Create page in `/app` directory
2. Add layout if needed
3. Protect route in middleware if required
4. Follow chunking principles for complex pages

---

## Terminology Rules

### User-Facing Terminology (MANDATORY)
- **Stakeholders**: Referred to as "Multipliers" throughout the project
- **Users**: Referred to as "Explorers" in UI
- **Community**: Referred to as "Squad"
- **Energy Crystals**: Gamification currency (also called "diamonds" in code)

### Messaging Rules (MANDATORY)

**Positive Framing** (MUST use):
- ‚úÖ "You're making great progress!"
- ‚úÖ "Continue your learning journey and unlock new achievements"
- ‚ùå **NEVER** use: "You haven't completed this yet"

**Achievement-Focused** (MUST use):
- ‚úÖ "Earn energy crystals, level up, and unlock achievements"
- ‚úÖ "Join a Community - Compete on leaderboards and celebrate wins"

---

## Current Implementation Status

### Completed ‚úÖ (Reference Only)
- Project setup (Next.js, TypeScript, Prisma)
- Design system foundation (colors, typography, CSS variables)
- Database schema design
- Base UI components (Button, Card, Input, ProgressBar, Badge)
- Logo component with progress bar
- GalaxyBackground animated component
- IntroCarousel component
- Gamified icon components (EnergyCrystal, StarCluster, ProgressChart, CommunityIcon, RocketIcon)
- Login page with carousel
- Signup page structure
- Authentication system (NextAuth.js v5)
- Protected routes middleware
- Home/landing page

### In Progress üöß (Reference Only)
- Signup page completion
- Dashboard page implementation
- Course listing page
- Progress tracking system

### Planned üìã (Reference Only)
- Course detail pages
- Task completion system
- Gamification calculations (XP, levels, badges)
- Leaderboard system
- Badge unlock system
- Streak tracking
- PWA features
- Push notifications
- Admin portal

---

## Critical Implementation Rules

### Database Rules
1. **NEVER** store plain text passwords - always hash with bcryptjs
2. **ALWAYS** enforce unique constraints (email, [userId, courseId], [userId, taskId])
3. **MUST** set default values on user creation (xp: 0, level: 1, rank: "Deckhand", streak: 0, diamonds: 0)
4. **MUST** use cuid for all primary keys
5. **MUST** maintain referential integrity (foreign keys)

### Authentication Rules
1. **MUST** validate all inputs with Zod schemas
2. **MUST** hash passwords with bcryptjs before storage
3. **MUST** use JWT strategy (stateless)
4. **MUST** protect routes with middleware
5. **MUST** redirect based on authentication status

### Gamification Rules
1. **MUST** award XP according to specified values (10, 50, 200, 1000)
2. **MUST** calculate levels using `Math.floor(xp / 1000) + 1`
3. **MUST** assign ranks based on level thresholds
4. **MUST** apply streak bonus (1.5x) when streak active
5. **MUST** prevent duplicate XP awards
6. **MUST** unlock badges automatically when criteria met

### Business Logic Rules
1. **MUST** calculate progress as `(completedTasks / totalTasks) * 100`
2. **MUST** enforce one completion per task per user
3. **MUST** only show published courses (`isPublished: true`)
4. **MUST** update user XP and level on task completion
5. **MUST** track progress per user per course

### API Rules
1. **MUST** use consistent response format: `{ success: boolean, data?: T, error?: string }`
2. **MUST** validate all inputs
3. **MUST** handle errors consistently
4. **MUST** return appropriate HTTP status codes

### Component Rules
1. **MUST** follow component structure pattern
2. **MUST** use CSS Modules (no inline styles except Framer Motion)
3. **MUST** export TypeScript interfaces for props
4. **MUST** follow naming conventions
5. **MUST** use CSS variables from `globals.css`

---

## Reference Documents

- `.cursorrules` - Complete project rules (complementary to this file)
- `docs/CONTEXTBIBLE.md` - Full context documentation
- `README.md` - Quick start guide
- `docs/BUILD_ORDER.md` - Development phases
- `docs/CSS_MODULES_GUIDE.md` - Styling guide
- `docs/TEAM_ROLES.md` - Team structure
- `docs/product/` - Product documentation (PRDs, roadmap, backlog)

---

**End of Context Bible Rules**

All agents working on the Learning Management System Web App **MUST** adhere to these rules. These rules complement `.cursorrules` and provide detailed technical specifications, business logic, and implementation patterns.

For updates or corrections, please update this document and increment the version number.

