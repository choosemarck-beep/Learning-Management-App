generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                              String                       @id @default(cuid())
  email                           String                       @unique
  name                            String
  password                        String
  avatar                          String?
  xp                              Int                          @default(0)
  level                           Int                          @default(1)
  rank                            String                       @default("Stellar Cadet")
  streak                          Int                          @default(0)
  diamonds                        Int                          @default(0)
  createdAt                       DateTime                     @default(now())
  updatedAt                       DateTime                     @updatedAt
  approvedAt                      DateTime?
  approvedBy                      String?
  emailVerified                   Boolean                      @default(false)
  onboardingCompleted             Boolean                      @default(false)
  role                            UserRole                     @default(EMPLOYEE)
  status                          UserStatus                   @default(PENDING)
  branch                          String?
  companyId                       String?
  department                      String?
  employeeNumber                  String?                      @unique
  hireDate                        DateTime?
  hireType                        HireType?
  phone                           String?
  positionId                      String?
  area                            String?
  region                          String?
  passwordResetToken              String?
  passwordResetTokenExpires       DateTime?
  activityLogs                    ActivityLog[]                @relation("ActivityLogUser")
  announcements                   Announcement[]               @relation("AnnouncementTrainer")
  approvalRequestsAdmin           ApprovalRequest[]            @relation("ApprovalRequestAdmin")
  approvalRequestsAreaManager     ApprovalRequest[]            @relation("ApprovalRequestAreaManager")
  approvalRequestsEmployee        ApprovalRequest[]            @relation("ApprovalRequestEmployee")
  approvalRequestsRegionalManager ApprovalRequest[]            @relation("ApprovalRequestRegionalManager")
  approvalRequestsCreated         ApprovalRequest[]            @relation("ApprovalRequestCreatedBy")
  badges                          Badge[]
  coursesCreated                  Course[]                     @relation("CourseCreator")
  courseProgresses                CourseProgress[]
  mandatoryTrainingsCreated       MandatoryTraining[]          @relation("MandatoryTrainingCreator")
  receivedMessages                Message[]                    @relation("ReceivedMessages")
  sentMessages                    Message[]                    @relation("SentMessages")
  miniQuizAttempts                MiniQuizAttempt[]
  miniTrainingProgresses          MiniTrainingProgress[]
  notifications                   Notification[]               @relation("UserNotifications")
  quizAttempts                    QuizAttempt[]
  sessions                        Session[]
  taskCompletions                 TaskCompletion[]
  dashboardPreferences            TrainerDashboardPreferences? @relation("TrainerDashboardPreferences")
  trainingsCreated                Training[]                   @relation("TrainingCreator")
  trainingProgresses              TrainingProgress[]           @relation("TrainingProgressUser")
  trainingProgressesNew           TrainingProgressNew[]        @relation("TrainingProgressNewUser")
  company                         Company?                     @relation(fields: [companyId], references: [id])
  position                        Position?                    @relation(fields: [positionId], references: [id])
  videoWatchProgresses            VideoWatchProgress[]
  reelsPlaylistSettingsUpdated    ReelsPlaylistSettings[]        @relation("ReelsPlaylistUpdater")
  reelLikes                       ReelLike[]                     @relation("ReelLikes")
  reelComments                    ReelComment[]                  @relation("ReelComments")

  @@index([email])
  @@index([xp])
  @@index([level])
  @@index([role])
  @@index([status])
  @@index([employeeNumber])
  @@index([companyId])
  @@index([positionId])
  @@index([branch])
  @@index([area])
  @@index([region])
}

model Course {
  id               String           @id @default(cuid())
  title            String
  description      String
  thumbnail        String?
  totalXP          Int              @default(0)
  isPublished      Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  createdBy        String?
  creator          User?            @relation("CourseCreator", fields: [createdBy], references: [id])
  courseProgresses CourseProgress[]
  modules          Module[]
  trainings        Training[]

  @@index([isPublished])
  @@index([createdBy])
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String
  order       Int
  totalXP     Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  thumbnail   String?
  lessons     Lesson[]
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([order])
}

model Lesson {
  id                   String               @id @default(cuid())
  moduleId             String
  title                String
  description          String
  order                Int
  totalXP              Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  minimumWatchTime     Int?
  videoDuration        Int?
  videoThumbnail       String?
  videoUrl             String?
  module               Module               @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  tasks                Task[]
  videoWatchProgresses VideoWatchProgress[]

  @@index([moduleId])
  @@index([order])
}

model Task {
  id              String           @id @default(cuid())
  lessonId        String
  title           String
  type            String
  content         String           @default("{}")
  order           Int
  xpReward        Int              @default(10)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  lesson          Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  taskCompletions TaskCompletion[]

  @@index([lessonId])
  @@index([order])
}

model CourseProgress {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  progress    Float    @default(0)
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model TaskCompletion {
  id          String   @id @default(cuid())
  userId      String
  taskId      String
  score       Int?
  completedAt DateTime @default(now())
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId])
  @@index([userId])
  @@index([taskId])
  @@index([completedAt])
}

model Badge {
  id          String   @id @default(cuid())
  userId      String
  type        String
  name        String
  description String
  icon        String
  earnedAt    DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model Company {
  id        String      @id @default(cuid())
  name      String      @unique
  type      CompanyType
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  users     User[]

  @@index([isActive])
  @@index([type])
}

model Position {
  id        String   @id @default(cuid())
  title     String   @unique
  role      UserRole
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@index([isActive])
  @@index([role])
}

model CarouselSettings {
  id        String       @id @unique @default(cuid())
  mode      CarouselMode @default(PHOTO_CAROUSEL)
  videoUrl  String?
  updatedBy String
  updatedAt DateTime     @updatedAt
  createdAt DateTime     @default(now())
}

model CarouselImage {
  id          String   @id @default(cuid())
  imageUrl    String
  title       String?
  description String?
  redirectUrl String?  // URL to redirect to when image is clicked
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, order])
}

model SplashScreenSettings {
  id        String   @id @default(cuid())
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AppLogoSettings {
  id        String   @id @default(cuid())
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ThemeSettings {
  id                      String   @id @default(cuid())
  primaryPurple           String?
  primaryIndigo           String?
  primaryDark             String?
  primaryDeep             String?
  accentCyan              String?
  accentTeal              String?
  starGold                String?
  starGoldDark            String?
  crystalPurple           String?
  crystalBright           String?
  bgDark                  String?
  bgDarkSecondary         String?
  textPrimary             String?
  textSecondary           String?
  statusSuccess           String?
  statusWarning           String?
  statusError             String?
  spacingXs               String?
  spacingSm               String?
  spacingMd               String?
  spacingLg               String?
  spacingXl               String?
  spacing2xl              String?
  fontFamily              String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  galaxyBackgroundEnabled Boolean? @default(true)
  plainBackgroundColor    String?
}

model Announcement {
  id        String           @id @default(cuid())
  title     String
  content   String
  type      AnnouncementType @default(GENERAL)
  trainerId String?
  isActive  Boolean          @default(true)
  priority  Int              @default(0)
  expiresAt DateTime?
  createdBy String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  trainer   User?            @relation("AnnouncementTrainer", fields: [trainerId], references: [id])

  @@index([isActive, priority, createdAt])
  @@index([trainerId])
}

model ApprovalRequest {
  id                        String         @id @default(cuid())
  employeeId                String
  requestedBy               String
  status                    ApprovalStatus @default(PENDING)
  requestComment            String?
  areaManagerId             String?
  areaManagerApproved       Boolean        @default(false)
  areaManagerApprovedAt     DateTime?
  areaManagerComment        String?
  regionalManagerId         String?
  regionalManagerApproved   Boolean        @default(false)
  regionalManagerApprovedAt DateTime?
  regionalManagerComment    String?
  adminId                   String?
  adminApproved             Boolean        @default(false)
  adminApprovedAt           DateTime?
  adminComment              String?
  rejectedBy                String?
  rejectedAt                DateTime?
  rejectionReason           String?
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  admin                     User?          @relation("ApprovalRequestAdmin", fields: [adminId], references: [id])
  areaManager               User?          @relation("ApprovalRequestAreaManager", fields: [areaManagerId], references: [id])
  employee                  User           @relation("ApprovalRequestEmployee", fields: [employeeId], references: [id], onDelete: Cascade)
  regionalManager           User?          @relation("ApprovalRequestRegionalManager", fields: [regionalManagerId], references: [id])
  createdBy                 User           @relation("ApprovalRequestCreatedBy", fields: [requestedBy], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([requestedBy])
  @@index([status])
  @@index([areaManagerId])
  @@index([regionalManagerId])
  @@index([adminId])
  @@index([createdAt])
}

model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  videoUrl    String
  thumbnail   String?
  duration    Int?
  category    String?
  views       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, createdAt])
  @@index([category])
}

model ReelsPlaylistSettings {
  id                String   @id @default(cuid())
  youtubePlaylistId String   // YouTube playlist ID (e.g., "PLrAXtmRdnEQy6nuLMH" from URL)
  playlistUrl       String   // Full YouTube playlist URL for reference
  isActive          Boolean  @default(true)
  updatedBy         String
  updatedAt         DateTime @updatedAt
  createdAt         DateTime @default(now())
  updater           User     @relation("ReelsPlaylistUpdater", fields: [updatedBy], references: [id])

  @@unique([id])
  @@index([isActive])
}

model ReelLike {
  id        String   @id @default(cuid())
  userId    String
  videoId   String   // YouTube video ID or our video ID
  createdAt DateTime @default(now())
  user      User     @relation("ReelLikes", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, videoId])
  @@index([videoId])
}

model ReelComment {
  id        String   @id @default(cuid())
  userId    String
  videoId   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("ReelComments", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([videoId])
  @@index([userId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  content   String
  isRead    Boolean   @default(false)
  readAt    DateTime?
  link      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([type])
}

model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  subject     String?
  content     String
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  recipient   User      @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId, isRead, createdAt])
}

model MandatoryTraining {
  id          String             @id @default(cuid())
  title       String
  description String?
  badgeIcon   String?
  badgeColor  String?
  isActive    Boolean            @default(true)
  createdBy   String
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  creator     User               @relation("MandatoryTrainingCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  progress    TrainingProgress[]

  @@index([isActive, createdAt])
  @@index([createdBy])
}

model TrainingProgress {
  id          String            @id @default(cuid())
  userId      String
  trainingId  String
  progress    Float             @default(0)
  isCompleted Boolean           @default(false)
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  training    MandatoryTraining @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user        User              @relation("TrainingProgressUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, trainingId])
  @@index([userId])
  @@index([trainingId])
  @@index([isCompleted])
}

model TrainerDashboardPreferences {
  id          String   @id @default(cuid())
  trainerId   String   @unique
  trainingIds String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  courseIds   String[]
  trainer     User     @relation("TrainerDashboardPreferences", fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId])
}

model Training {
  id               String                @id @default(cuid())
  courseId         String
  title            String
  shortDescription String?
  videoUrl         String?
  videoDuration    Int?
  videoThumbnail   String?
  minimumWatchTime Int?
  order            Int
  totalXP          Int                   @default(0)
  isPublished      Boolean               @default(false)
  createdBy        String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  miniTrainings    MiniTraining[]
  quiz             Quiz?
  course           Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  creator          User?                 @relation("TrainingCreator", fields: [createdBy], references: [id])
  trainingProgress TrainingProgressNew[]

  @@index([courseId])
  @@index([order])
  @@index([isPublished])
  @@index([createdBy])
}

model Quiz {
  id             String        @id @default(cuid())
  trainingId     String        @unique
  title          String
  passingScore   Int           @default(70)
  timeLimit      Int?
  allowRetake    Boolean       @default(true)
  maxAttempts    Int?
  questions      String        @default("[]")
  questionsToShow Int?         // Number of questions to randomly show per attempt (null = show all)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  training       Training      @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  quizAttempts   QuizAttempt[]

  @@index([trainingId])
}

model MiniTraining {
  id                   String                 @id @default(cuid())
  trainingId           String
  title                String
  description          String?
  videoUrl             String?
  videoDuration        Int?
  order                Int
  isRequired           Boolean                @default(true)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  miniQuiz             MiniQuiz?
  training             Training               @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  miniTrainingProgress MiniTrainingProgress[]

  @@index([trainingId])
  @@index([order])
}

model MiniQuiz {
  id               String            @id @default(cuid())
  miniTrainingId   String            @unique
  title            String
  passingScore     Int               @default(70)
  questions        String            @default("[]")
  questionsToShow  Int?               // Number of questions to randomly show per attempt (null = show all)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  miniTraining     MiniTraining      @relation(fields: [miniTrainingId], references: [id], onDelete: Cascade)
  miniQuizAttempts MiniQuizAttempt[]

  @@index([miniTrainingId])
}

model TrainingProgressNew {
  id                     String    @id @default(cuid())
  userId                 String
  trainingId             String
  videoProgress          Float     @default(0)
  videoWatchedSeconds    Int       @default(0)
  quizCompleted          Boolean   @default(false)
  quizScore              Int?
  quizPostponed          Boolean   @default(false)
  miniTrainingsCompleted Int       @default(0)
  totalMiniTrainings     Int       @default(0)
  progress               Float     @default(0)
  isCompleted            Boolean   @default(false)
  completedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  training               Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user                   User      @relation("TrainingProgressNewUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, trainingId])
  @@index([userId])
  @@index([trainingId])
}

model MiniTrainingProgress {
  id             String       @id @default(cuid())
  userId         String
  miniTrainingId String
  videoProgress  Float        @default(0)
  quizCompleted  Boolean      @default(false)
  quizScore      Int?
  isCompleted    Boolean      @default(false)
  completedAt    DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  miniTraining   MiniTraining @relation(fields: [miniTrainingId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, miniTrainingId])
  @@index([userId])
  @@index([miniTrainingId])
}

model QuizAttempt {
  id          String    @id @default(cuid())
  userId      String
  quizId      String
  score       Int
  answers     String    @default("{}")
  timeSpent   Int?
  passed      Boolean
  startedAt   DateTime?
  completedAt DateTime  @default(now())
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([completedAt])
  @@index([startedAt])
}

model MiniQuizAttempt {
  id          String    @id @default(cuid())
  userId      String
  miniQuizId  String
  score       Int
  answers     String    @default("{}")
  timeSpent   Int?
  passed      Boolean
  startedAt   DateTime?
  completedAt DateTime  @default(now())
  miniQuiz    MiniQuiz  @relation(fields: [miniQuizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([miniQuizId])
  @@index([startedAt])
}

model ActivityLog {
  id          String       @id @default(cuid())
  type        ActivityType
  userId      String
  targetId    String?
  targetType  String?
  description String
  metadata    String?
  createdAt   DateTime     @default(now())
  user        User         @relation("ActivityLogUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([targetId, targetType])
  @@index([createdAt])
}

model VideoWatchProgress {
  id             String   @id @default(cuid())
  userId         String
  lessonId       String
  watchedSeconds Int      @default(0)
  lastWatchedAt  DateTime @default(now())
  isCompleted    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  lesson         Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  BRANCH_MANAGER
  EMPLOYEE
  REGIONAL_MANAGER
  AREA_MANAGER
  TRAINER
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  RESIGNED
}

enum CompanyType {
  COMPANY
  AGENCY
}

enum HireType {
  DIRECT_HIRE
  AGENCY
}

enum AnnouncementType {
  GENERAL
  QUIZ
  NEW_TRAINING
  IMPORTANT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum CarouselMode {
  PHOTO_CAROUSEL
  VIDEO
}

enum ActivityType {
  TRAINING_CREATED
  TRAINING_UPDATED
  TRAINING_DELETED
  TRAINING_ACTIVATED
  TRAINING_DEACTIVATED
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_APPROVED
  USER_REJECTED
}
